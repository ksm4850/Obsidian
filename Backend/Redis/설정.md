# Redis Docker 설정 가이드

## Docker 기본 실행

### 기본 명령어

```bash
docker run -d \
  --name redis \
  -p 6379:6379 \
  redis:latest
```

### 데이터 영속화 (볼륨 마운트)

```bash
docker run -d \
  --name redis \
  -p 6379:6379 \
  -v redis-data:/data \
  redis:latest
```

---

## 메모리 제한 설정

### 1. Docker 레벨 메모리 제한

```bash
docker run -d \
  --name redis \
  --memory="2g" \
  --memory-swap="2g" \
  -p 6379:6379 \
  redis:latest
```

**옵션 설명:**

- `--memory`: 컨테이너 최대 메모리
- `--memory-swap`: swap 메모리 (같은 값 설정 시 swap 미사용)

### 2. Redis 자체 [[#메모리 관리|메모리 제한 + 삭제 정책]]

```bash
docker run -d \
  --name redis \
  -p 6379:6379 \
  redis:latest \
  redis-server --maxmemory 2gb --maxmemory-policy allkeys-lru
```

### 3. 권장 설정 (Docker + Redis 둘 다)

```bash
docker run -d \
  --name redis \
  --memory="2g" \
  --memory-swap="2g" \
  -p 6379:6379 \
  -v redis-data:/data \
  redis:latest \
  redis-server --maxmemory 2gb --maxmemory-policy allkeys-lru
```

---

## Redis 설정 파일

### redis.conf 생성

```conf
# 기본 설정
bind 0.0.0.0
port 6379
protected-mode yes
requirepass your_password_here

# 메모리 설정
maxmemory 2gb
maxmemory-policy allkeys-lru

# 영속성 설정
save 900 1      # 900초 동안 1개 이상 변경시 저장
save 300 10     # 300초 동안 10개 이상 변경시 저장
save 60 10000   # 60초 동안 10000개 이상 변경시 저장

# AOF (Append Only File) 설정
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec

# 로그 설정
loglevel notice
logfile ""

# 성능 설정
tcp-backlog 511
timeout 0
tcp-keepalive 300
```

### 설정 파일 사용하여 실행

```bash
docker run -d \
  --name redis \
  -p 6379:6379 \
  -v $(pwd)/redis.conf:/usr/local/etc/redis/redis.conf \
  -v redis-data:/data \
  redis:latest \
  redis-server /usr/local/etc/redis/redis.conf
```

---

## Docker Compose 설정

### docker-compose.yml

```yaml
version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    
    ports:
      - "6379:6379"
    
    # Docker 레벨 메모리 제한
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    
    # Redis 설정
    command: >
      redis-server
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --requirepass your_password_here
    
    # 볼륨 마운트
    volumes:
      - redis-data:/data
      # - ./redis.conf:/usr/local/etc/redis/redis.conf  # 설정 파일 사용시
    
    # 헬스체크
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    
    # 네트워크
    networks:
      - backend

volumes:
  redis-data:
    driver: local

networks:
  backend:
    driver: bridge
```

### 실행 명령어

```bash
# 시작
docker-compose up -d

# 로그 확인
docker-compose logs -f redis

# 중지
docker-compose down

# 볼륨까지 삭제
docker-compose down -v
```

---

## 주요 Redis 설정 옵션

### 메모리 관리

#### maxmemory-policy (삭제 정책)

| 정책                | 설명                     | 사용 사례         |
| ----------------- | ---------------------- | ------------- |
| `allkeys-lru`     | 모든 키 중 가장 오래 사용안된 것 삭제 | 일반적인 캐시 (추천)  |
| `allkeys-lfu`     | 모든 키 중 사용 빈도 낮은 것 삭제   | 빈도 기반 캐시      |
| `allkeys-random`  | 랜덤 삭제                  | 모든 키가 동일한 중요도 |
| `volatile-lru`    | TTL 설정된 키 중 LRU 삭제     | 일부 키만 삭제 대상   |
| `volatile-lfu`    | TTL 설정된 키 중 LFU 삭제     | TTL + 빈도 기반   |
| `volatile-ttl`    | TTL 짧은 키부터 삭제          | 만료 임박 키 우선    |
| `volatile-random` | TTL 설정된 키 중 랜덤         | TTL + 랜덤      |
| `noeviction`      | 삭제 안함 (에러 반환)          | 데이터 유실 방지 필요시 |

### 영속성 설정

#### RDB (스냅샷)

```conf
# 특정 조건 만족시 디스크 저장
save 900 1      # 15분 동안 1개 이상 변경
save 300 10     # 5분 동안 10개 이상 변경
save 60 10000   # 1분 동안 10000개 이상 변경

# 스냅샷 파일명
dbfilename dump.rdb

# 저장 실패시 쓰기 중지
stop-writes-on-bgsave-error yes

# 압축 사용
rdbcompression yes
```

#### AOF (Append Only File)

```conf
# AOF 활성화
appendonly yes

# AOF 파일명
appendfilename "appendonly.aof"

# 동기화 정책
appendfsync everysec    # 매초 동기화 (추천)
# appendfsync always    # 매 명령마다 (느림, 안전)
# appendfsync no        # OS에 맡김 (빠름, 위험)

# AOF 재작성 설정
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

### 보안 설정

```conf
# 비밀번호 설정
requirepass your_strong_password

# 바인딩 주소 (특정 IP만 접근)
bind 127.0.0.1 192.168.1.100

# Protected mode
protected-mode yes

# 위험한 명령어 비활성화
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
```

### 성능 설정

```conf
# 최대 클라이언트 수
maxclients 10000

# TCP backlog
tcp-backlog 511

# Timeout (0 = 무제한)
timeout 0

# TCP keepalive
tcp-keepalive 300

# 데이터베이스 개수
databases 16

# 슬로우 로그
slowlog-log-slower-than 10000  # 10ms 이상
slowlog-max-len 128
```

---

## 운영 팁

### 1. 메모리 모니터링

```bash
# Redis CLI 접속
docker exec -it redis redis-cli

# 메모리 사용량 확인
INFO memory

# 특정 정보만 확인
INFO memory | grep used_memory_human
```

### 2. 백업 명령어

```bash
# RDB 스냅샷 생성
docker exec redis redis-cli BGSAVE

# AOF 재작성
docker exec redis redis-cli BGREWRITEAOF

# 백업 파일 복사
docker cp redis:/data/dump.rdb ./backup/
docker cp redis:/data/appendonly.aof ./backup/
```

### 3. 성능 테스트

```bash
# 벤치마크 실행
docker exec redis redis-benchmark -q -n 100000

# 특정 명령어만 테스트
docker exec redis redis-benchmark -t set,get -n 100000 -q
```

### 4. 모니터링

```bash
# 실시간 명령어 모니터링
docker exec -it redis redis-cli MONITOR

# 통계 정보
docker exec redis redis-cli INFO stats

# 슬로우 로그 확인
docker exec redis redis-cli SLOWLOG GET 10
```

### 5. 비밀번호 설정 후 접속

```bash
# 환경변수로 비밀번호 전달
docker exec -it redis redis-cli -a your_password

# 또는 접속 후 인증
docker exec -it redis redis-cli
AUTH your_password
```

---

## FastAPI 연동 예시

### 설치

```bash
pip install redis
```

### 연결 코드 (참고용)

```python
from redis import Redis
from redis.connection import ConnectionPool

# Connection Pool 생성
pool = ConnectionPool(
    host='localhost',
    port=6379,
    password='your_password',  # 비밀번호 설정시
    db=0,
    max_connections=10,
    decode_responses=True
)

# Redis 클라이언트
redis_client = Redis(connection_pool=pool)

# 사용 예시
redis_client.set('key', 'value', ex=3600)  # 1시간 TTL
value = redis_client.get('key')
```

